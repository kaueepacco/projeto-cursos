<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curso</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="curso-container">
    <h1 id="curso-title"></h1>
    <p id="curso-desc"></p>

    <div id="curso-material"></div>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;">
      <button onclick="window.location.href='index.html'" class="back">← Voltar</button>
      <button id="quiz-btn">Ir para o Quiz →</button>
    </div>

    <div id="curso-error" style="color:#fff;margin-top:16px;text-align:center;"></div>
  </div>

  <script src="data/cursos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const cursoId = urlParams.get('id');
      const errorDiv = document.getElementById('curso-error');

      if (typeof cursos === 'undefined' || !Array.isArray(cursos)) {
        if (errorDiv) errorDiv.textContent = 'Erro ao carregar os cursos. Verifique data/cursos.js';
        console.error('Variável "cursos" indefinida.');
        return;
      }

      if (cursoId === null || typeof cursos[cursoId] === 'undefined') {
        if (errorDiv) errorDiv.textContent = 'Curso não encontrado. Volte para a página inicial.';
        return;
      }

      const curso = cursos[cursoId];
      document.getElementById('curso-title').textContent = curso.title || 'Curso';
      document.getElementById('curso-desc').textContent = curso.description || '';

      const materialDiv = document.getElementById('curso-material');
      materialDiv.innerHTML = '';

      if (curso.materials && curso.materials.length) {
        curso.materials.forEach((m, idx) => {
          const block = document.createElement('div');
          block.className = 'material-item';
          block.innerHTML = `
            <h3>${m.title || ''}</h3>
            <div class="video-wrap">
              <video class="curso-video" data-vid-index="${idx}" src="${m.video}" controls></video>
            </div>
          `;
          materialDiv.appendChild(block);
        });
      } else {
        materialDiv.innerHTML = "<p>Nenhum material disponível.</p>";
      }

      // --- PROGRESSO SALVO: chave por curso ---
      const progressoKey = `curso_${cursoId}_videos_progress`;
      let progresso = JSON.parse(localStorage.getItem(progressoKey) || "null");
      const videos = Array.from(document.querySelectorAll('.curso-video'));

      if (!Array.isArray(progresso) || progresso.length !== videos.length) {
        progresso = videos.map(() => ({ currentTime: 0, ended: false }));
      }

      // atualiza contador inicial
      let videosAssistidos = progresso.filter(p => p.ended).length;

      const quizBtn = document.getElementById('quiz-btn');
      function tryUnlockQuiz() {
        if (videosAssistidos === videos.length && videos.length > 0) {
          quizBtn.disabled = false;
          quizBtn.classList.remove('disabled');
        }
      }

      // Aplica progresso salvo e registra listeners
      videos.forEach((video, index) => {
        const saved = progresso[index] || { currentTime: 0, ended: false };

        // restaura tempo (se houver)
        try {
          if (saved.currentTime && !isNaN(saved.currentTime) && saved.currentTime > 0 && saved.currentTime < (video.duration || Infinity)) {
            video.addEventListener('loadedmetadata', () => {
              if (saved.currentTime < video.duration) video.currentTime = saved.currentTime;
            });
          }
        } catch (e) {  }

        if (saved.ended) {
          video.classList.add('finished'); // podes estilizar .finished se quiser
        }

        // timeupdate -> salva tempo atual (com throttle simples)
        let lastSaveAt = 0;
        video.addEventListener('timeupdate', () => {
          const now = Date.now();
          if (now - lastSaveAt < 1000) return;
          lastSaveAt = now;

          progresso[index] = progresso[index] || {};
          progresso[index].currentTime = video.currentTime;
          try { localStorage.setItem(progressoKey, JSON.stringify(progresso)); } catch(e){ console.error(e); }
        });

        // ended -> marca concluído e salva
        video.addEventListener('ended', () => {
          if (!progresso[index] || !progresso[index].ended) {
            progresso[index] = progresso[index] || {};
            progresso[index].ended = true;
            progresso[index].currentTime = video.duration || 0;
            try { localStorage.setItem(progressoKey, JSON.stringify(progresso)); } catch(e){ console.error(e); }
            video.classList.add('finished');
            videosAssistidos++;
            tryUnlockQuiz();
          }
        });
      });

      // Bloqueia botão por padrão e tenta liberar se já assistidos
      quizBtn.disabled = true;
      quizBtn.classList.add('disabled');
      tryUnlockQuiz();

      quizBtn.addEventListener('click', () => {
        if (!quizBtn.disabled) {
          window.location.href = `quiz.html?id=${cursoId}`;
        }
      });
    });
  </script>
</body>
</html>


